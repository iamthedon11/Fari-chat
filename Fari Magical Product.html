<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daraz Product Chatbot</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef1f7;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }
    .container {
        width: 100%;
        max-width: 800px;
        background: white;
        margin-top: 30px;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .chat-box {
        height: 500px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }
    .msg {
        padding: 10px 14px;
        border-radius: 10px;
        margin-bottom: 12px;
        max-width: 75%;
        line-height: 1.4;
    }
    .bot {
        background: #e3e8ff;
        color: #333;
    }
    .user {
        background: #667eea;
        color: white;
        margin-left: auto;
    }
    .input-area {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
    input {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        background: #667eea;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }
</style>
</head>
<body>

<div class="container">
    <h2>üõçÔ∏è Fari Magical Product Chatbot</h2>

    <div class="chat-box" id="chatBox"></div>

    <div class="input-area">
        <input id="userInput" placeholder="Ask about products...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
let productData = [];

// 1Ô∏è‚É£ Load your product data from the sheet API
window.onload = function() {
    fetch("https://script.google.com/macros/s/AKfycbwDSDeQNzeFHWBYH3CL6ScnBJweWgUkFyceQSepMQWTZB7MGaIFi_EqaMIkf2NKFbg3/exec")
        .then(r => r.json())
        .then(data => {
            productData = data;
            addBot("Loaded " + productData.length + " products! Ask anything about them.");
        })
        .catch(() => {
            addBot("Failed to load live products. Using demo data.");
            productData = [
                { "Product Name": "Samsung A54", "Price": "100000", "Category": "Mobiles" },
                { "Product Name": "Nike Shoes", "Price": "15000", "Category": "Fashion" }
            ];
        });
};

// Render bot messages with basic formatting
function addBot(text) {
    const box = document.getElementById("chatBox");

    let formatted = text || "";

    // Clean up some markdown-ish patterns
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1'); // remove **bold**
    formatted = formatted.replace(/\n\d+\.\s/g, '\n‚Ä¢ ');   // "1. " ‚Üí "‚Ä¢ "
    formatted = formatted.replace(/\n-\s/g, '\n‚Ä¢ ');       // "- " ‚Üí "‚Ä¢ "

    // Escape HTML then convert newlines to <br>
    formatted = formatted
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\n/g, "<br>");

    box.innerHTML += `<div class="msg bot">${formatted}</div>`;
    box.scrollTop = box.scrollHeight;
}

function addUser(text) {
    const box = document.getElementById("chatBox");
    const safe = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    box.innerHTML += `<div class="msg user">${safe}</div>`;
    box.scrollTop = box.scrollHeight;
}

// 2Ô∏è‚É£ Send user question + product data to your GPT backend
async function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;

    addUser(text);
    input.value = "";

    addBot("Thinking...");

    try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbzerkNn7GThDFGVo1MW2iLVQd2_8UqtO6KQ81LLrSVrotnlIpRnkw6_1RoEMyXuMIjS/exec", {
            method: "POST",
            body: JSON.stringify({
                message: text,
                productData: productData
            })
        });

        const data = await response.json();
        document.querySelector(".msg.bot:last-child").remove();

        if (data.error) {
            addBot("‚ùå Error: " + data.error);
            return;
        }

        const answer = data.choices[0].message.content;
        addBot(answer);
    } catch (err) {
        document.querySelector(".msg.bot:last-child").remove();
        addBot("‚ùå Network or server error: " + err.message);
    }
}

// Allow Enter key to send
document.getElementById("userInput").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        sendMessage();
    }
});
</script>

</body>
</html>
