<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daraz Product Chatbot</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef1f7;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }
    .container {
        width: 100%;
        max-width: 800px;
        background: white;
        margin-top: 30px;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .chat-box {
        height: 500px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }
    .msg {
        padding: 10px 14px;
        border-radius: 10px;
        margin-bottom: 12px;
        max-width: 75%;
        line-height: 1.4;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .bot {
        background: #e3e8ff;
        color: #333;
    }
    .user {
        background: #667eea;
        color: white;
        margin-left: auto;
    }
    .input-area {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
    input {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        background: #667eea;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Optional: left a details style in case you ever output <details> later */
    details {
        margin-bottom: 8px;
        background: #f8fafc;
        border-radius: 6px;
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
    }
    details summary {
        cursor: pointer;
        font-weight: 600;
    }
    details[open] {
        background: #eef2ff;
    }
</style>
</head>
<body>

<div class="container">
    <h2>üõçÔ∏è fArI Genie</h2>

    <div class="chat-box" id="chatBox"></div>

    <div class="input-area">
        <input id="userInput" placeholder="Ask about products... (e.g. &quot;3 racks above 3000 with sales count above 50&quot;)">
        <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
// üîó APIs
const PRODUCTS_API_URL = "https://script.google.com/macros/s/AKfycbwDSDeQNzeFHWBYH3CL6ScnBJweWgUkFyceQSepMQWTZB7MGaIFi_EqaMIkf2NKFbg3/exec";
const GPT_BACKEND_URL  = "https://script.google.com/macros/s/AKfycbz2HJQtnqk6RbhJYyjOS2m4m8skiRYvoKC3Ea25APf0S-M2mtNQuKA3Lohpb9Je-7I/exec";

let productData = [];

// üîë Simple per-browser session ID (so backend can use CacheService per user)
let SESSION_ID = (function () {
    const KEY = "daraz_chatbot_session_id";
    let existing = localStorage.getItem(KEY);
    if (existing) return existing;
    const newId = "sess_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    localStorage.setItem(KEY, newId);
    return newId;
})();

// 1Ô∏è‚É£ Load product data
window.onload = function() {
    addBot("Loading products from sheet...");
    fetch(PRODUCTS_API_URL)
        .then(r => r.json())
        .then(data => {
            // Keep data as-is; backend will handle 2D or objects
            productData = data;
            let count = Array.isArray(data) ? data.length : 0;

            // Replace the "Loading..." bot message with final status
            const lastBot = document.querySelector(".msg.bot:last-child");
            if (lastBot && lastBot.textContent.indexOf("Loading products from sheet") !== -1) {
                lastBot.remove();
            }

            addBot("‚úÖ Loaded " + count + " product rows from your sheet.\n\n" +
                   "You can ask things like:\n" +
                   "‚Ä¢ give me 3 racks above 3000 with sales count above 50\n" +
                   "‚Ä¢ top 5 sandwich makers by sales\n" +
                   "‚Ä¢ best selling electronics sorted by seller name");
            console.log("Loaded productData:", productData);
        })
        .catch((err) => {
            console.error("Product load error:", err);
            const lastBot = document.querySelector(".msg.bot:last-child");
            if (lastBot && lastBot.textContent.indexOf("Loading products from sheet") !== -1) {
                lastBot.remove();
            }
            addBot("‚ö†Ô∏è Failed to load live products. Using small demo data.");
            productData = [
                { "Product Name": "Samsung A54", "Price": "100000", "Category": "Mobiles" },
                { "Product Name": "Nike Shoes", "Price": "15000", "Category": "Fashion" }
            ];
        });

    // Enter key handler
    document.getElementById("userInput").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });
};

// Render bot messages with basic formatting
function addBot(text) {
    const box = document.getElementById("chatBox");
    let formatted = text || "";

    // Remove markdown **bold** if GPT ever sends it
    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1');

    // Block scripts
    formatted = formatted
        .replace(/<script/gi, "&lt;script")
        .replace(/<\/script/gi, "&lt;/script")
        .replace(/\n/g, "<br>");

    box.innerHTML += `<div class="msg bot">${formatted}</div>`;
    box.scrollTop = box.scrollHeight;
}

function addUser(text) {
    const box = document.getElementById("chatBox");
    const safe = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    box.innerHTML += `<div class="msg user">${safe}</div>`;
    box.scrollTop = box.scrollHeight;
}

// Small helper to disable/enable send button while waiting
function setSending(state) {
    const btn = document.getElementById("sendBtn");
    const input = document.getElementById("userInput");
    btn.disabled = state;
    input.disabled = state;
}

// 2Ô∏è‚É£ Send user question + product data + sessionId to GPT backend
async function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;

    addUser(text);
    input.value = "";

    addBot("Thinking...");
    setSending(true);

    try {
        const response = await fetch(GPT_BACKEND_URL, {
            method: "POST",
            // ‚ùó Important: no custom headers, Apps Script doesn't like CORS preflight
            body: JSON.stringify({
                message: text,
                productData: productData,
                sessionId: SESSION_ID   // enables context in backend
            })
        });

        const rawText = await response.text();
        console.log("Raw backend response:", rawText);

        let data;
        try {
            data = JSON.parse(rawText);
        } catch (e) {
            // Remove "Thinking..."
            const lastBot = document.querySelector(".msg.bot:last-child");
            if (lastBot) lastBot.remove();
            setSending(false);
            addBot("‚ùå Backend did not return valid JSON.<br><br>" + rawText);
            return;
        }

        // Remove "Thinking..."
        const lastBot = document.querySelector(".msg.bot:last-child");
        if (lastBot) lastBot.remove();
        setSending(false);

        if (data.error) {
            addBot("‚ùå Error from server: " + data.error);
            return;
        }

        // Try common fields; fallback to printing JSON
        const answer =
            data.response ||
            data.reply ||
            data.output ||
            data.message ||
            JSON.stringify(data, null, 2);

        addBot(answer);

    } catch (err) {
        console.error("Chat error:", err);
        const lastBot = document.querySelector(".msg.bot:last-child");
        if (lastBot) lastBot.remove();
        setSending(false);
        addBot("‚ùå Network or server error: " + err.message);
    }
}
</script>

</body>
</html>
